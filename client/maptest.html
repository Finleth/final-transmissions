<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.5/howler.core.min.js"></script>

    <title>Display Webcam Stream</title>

    <style>

        body {
            background-color: #242f3e;
        }

        #container {
            margin: 0px 0px;
            width: 100vw;
            height: 100vh;
            border: none;
            position: absolute;
            left: 0%;
            top: 0%;
        }

        .output {
            display: block;
            font-size: 1.5rem;
            color: blue;
            text-align: center;
        }

        #map {
            height: 105vh;
            width: 105vw;
            border: none;
            position: absolute;
            top: 0%;
            left: -20px;
            background-color: #242f3e;
        }

        .concealer {
            height: 100vh;
            width: 100vw;
            border: none;
            position: absolute;
            top: 0%;
            left: 0%;
            overflow: hidden;
        }

        .refresh {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            background-color: red;
            height: 10vmin;
            width: 10vmin;
            color: yellow;
            border-radius: 100%;
            cursor: pointer;
        }

        .toplayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 10vmin;
            color: yellow;
            text-align: center;
            font-size: 2rem;
        }

    </style>
</head>

<body>
    <div class="concealer">
            <div id="map"></div>
    </div>
    <div class="toplayer"></div>
    <div class="refresh" ontouchstart="getLocation()"></div>

    <script>



        //geolocation
        var locationdata;
        var coord;
        var marker;
        var average = [];
        var startPoint;
        var mapLoaded = false;
        var map;
        var target = {
            latitude: 33.6350687,
            longitude: -117.7402043,
            threshold: 8
        }

        //Out front of apartment
        // var target = {
        //     latitude: 33.7523889,
        //     longitude: -117.8637263,
        //     threshold: 10
        // };

        var sound = new Howl ({
            src: ['../assets/0951.ogg'],
            autoplay: false,
            loop: true,
            volume: 0,
            onloaderror: function(){
                console.log('sound load error');
            }
        });
        sound.audible = false;

        //##
        //our general purpose call for location locationdata
        //this could get wrapped up into a player object as a method
        //##
        function getLocation() {
            if (!sound.playing()){
                sound.play();
            }
            console.log('getting location');
            var options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maxAge: 10000
            };

            if (!coord && navigator.geolocation) {
                //If we have not gotten a location then call for one
                navigator.geolocation.getCurrentPosition(showSuccess,showError,options);
            } else if (navigator.geolocation){
                //otherwise, watch the position
                navigator.geolocation.watchPosition(showSuccess,showError,options);
            }else {
                location = "Geolocation is not supported by this browser.";
            }

            //##
            //Not sure about the need to have this here
            //move outside of the parent function?
            //##
            function showSuccess(pos) {
                //##
                //pos also includes pos.timestamp
                //which can be used for discarding spurious results
                //when combined with a calculated distance from origin
                //##
                coord = pos.coords;


                if(mapLoaded === false){
                    initMap();

                    mapLoaded = true;
                }
                console.log(coord);
                let place = document.querySelector('.toplayer');


                showCurrentLocation(coord);
                var distance = getDistanceFromLatLonInKm(coord.latitude,coord.longitude,target.latitude,target.longitude);

                if ( distance <= target.threshold){
                    place.innerHTML= `Within ${target.threshold}m of location!!`;
                    sound.fade(0,1,4000);
                    sound.audible = true;

                } else {
                    place.innerHTML= `${coord.latitude} <br /> ${coord.longitude} <br />Success!<br />${distance}`;
                    if (sound.audible){
                        sound.fade(1,0,2000);
                        sound.audible = false;
                    }
                }
            }

            function showError(err){
                console.warn(`ERROR(${err.code}): ${err.message}`);
                let place = document.querySelector('.toplayer');
                place.innerHTML= `Error!`;
            }
        }

        //##
        //Make an initial call on load in order to bring up map data
        getLocation();


        //##
        //distance calc for anything we put into it
        //takes latitude and longitude for each object
        //maybe switch this to be passed as objects?
        //Outputs a number representing distance in meters
        //##
        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  // deg2rad below
            var dLon = deg2rad(lon2-lon1);
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            var d = R * c; // Distance in km
            return d * 1000; //Distance in meters
        }

        //##
        //used in the get distance calc in order to use radians
        //##
        function deg2rad(deg) {
            return deg * (Math.PI/180)
        }



        //##
        //gets called on first location success within getLocation()
        //##
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 33.6348729, lng: -117.7405317},
                zoom: 19,
                disableDefaultUI: true,
                draggable: false,
                styles: [
                  {
                    "elementType": "geometry",
                    "stylers": [
                      {
                        "color": "#242f3e"
                      }
                    ]
                  },
                  {
                    "elementType": "labels",
                    "stylers": [
                      {
                        "visibility": "off"
                      }
                    ]
                  },
                  {
                    "featureType": "administrative",
                    "elementType": "geometry.fill",
                    "stylers": [
                      {
                        "color": "#242f3e"
                      }
                    ]
                  },
                  {
                    "featureType": "administrative",
                    "elementType": "geometry.stroke",
                    "stylers": [
                      {
                        "color": "#30ff27"
                      }
                    ]
                  },
                  {
                    "featureType": "landscape.man_made",
                    "elementType": "geometry.stroke",
                    "stylers": [
                      {
                        "color": "#30ff27"
                      },
                      {
                        "visibility": "on"
                      },
                      {
                        "weight": 8
                      }
                    ]
                  },
                  {
                    "featureType": "landscape.natural",
                    "elementType": "geometry.stroke",
                    "stylers": [
                      {
                        "color": "#d41d1c"
                      }
                    ]
                  },
                  {
                    "featureType": "road",
                    "elementType": "geometry",
                    "stylers": [
                      {
                        "color": "#38414e"
                      }
                    ]
                  },
                  {
                    "featureType": "road",
                    "elementType": "geometry.stroke",
                    "stylers": [
                      {
                        "color": "#388924"
                      },
                      {
                        "visibility": "simplified"
                      }
                    ]
                  },
                  {
                    "featureType": "transit",
                    "elementType": "geometry",
                    "stylers": [
                      {
                        "color": "#2f3948"
                      }
                    ]
                  },
                  {
                    "featureType": "transit",
                    "elementType": "geometry.stroke",
                    "stylers": [
                      {
                        "color": "#265918"
                      },
                      {
                        "visibility": "simplified"
                      }
                    ]
                  },
                  {
                    "featureType": "water",
                    "elementType": "geometry",
                    "stylers": [
                      {
                        "color": "#17263c"
                      }
                    ]
                  }
                ]
            });

            var iconBase = './assets/images/shaded_dot.png';
            marker = new google.maps.Marker({
                position: {
                    lat: 33.6348729,
                    lng: -117.7405317
                },
                map: map,
                icon: iconBase
            });
        }


        //##
        //Works to show location, but is not yet handling clearing the marker and replacing it in a new spot
        //it just adds another one, Im also uncertain as to whether it is recentering the map?
        //##

        function showCurrentLocation(loc){
            map.setCenter({lat:loc.latitude, lng:loc.longitude, alt:0});
            marker.setPosition({lat:loc.latitude, lng:loc.longitude, alt:0});
        }

    </script>

<!-- Not sure why this script tag is all the way down ehre instead of on m=page load at the top?
 Remember to ask Lori about it -BE -->
 <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXqyuEI8wFxFvczjGjlbim35FAuco0oCU&callback=initMap"
 async defer></script>

 <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXqyuEI8wFxFvczjGjlbim35FAuco0oCU&"
 async defer></script> -->

</body>
</html>
